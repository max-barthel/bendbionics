# BendBionics Production Overrides
#
# Purpose: Production-specific settings and resource limits
# Usage: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
#
# This file extends docker-compose.yml with production optimizations:
# - Resource limits (CPU, memory)
# - PostgreSQL performance tuning
# - Gunicorn worker configuration for backend
# - Production-ready restart policies

services:
  postgres:
    # Production database settings
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=100
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

  backend:
    # Production backend settings
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    # Override worker count for production
    command: >
      uv run gunicorn app.main:app
      --workers 4
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000
      --timeout 120
      --keep-alive 2
      --max-requests 1000
      --max-requests-jitter 50
      --access-logfile -
      --error-logfile -
      --log-level info

  frontend:
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M

  nginx:
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M

  certbot:
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
