#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."

# Check if we're in the right directory
if [ ! -f "package.json" ] || [ ! -d "frontend" ] || [ ! -d "backend" ]; then
  echo "âŒ Please run this script from the project root directory"
  exit 1
fi

# Run comprehensive tests
echo "ğŸ§ª Running comprehensive test suite..."

# Frontend tests with coverage
echo "ğŸ“ Running frontend tests with coverage..."
cd frontend
npm run test:coverage
if [ $? -ne 0 ]; then
  echo "âŒ Frontend tests failed. Please fix the failing tests before pushing."
  exit 1
fi
cd ..

# Backend tests with coverage
echo "ğŸ Running backend tests with coverage..."
cd backend
python -m pytest --cov=app --cov-report=term-missing --cov-report=html:htmlcov
if [ $? -ne 0 ]; then
  echo "âŒ Backend tests failed. Please fix the failing tests before pushing."
  exit 1
fi
cd ..

# Run linting checks
echo "ğŸ” Running comprehensive linting..."

# Frontend linting
echo "ğŸ“ Running frontend linting..."
cd frontend
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Frontend linting failed. Please fix the issues before pushing."
  exit 1
fi
cd ..

# Backend linting
echo "ğŸ Running backend linting..."
cd backend
python -m flake8 .
if [ $? -ne 0 ]; then
  echo "âŒ Backend linting failed. Please fix the issues before pushing."
  exit 1
fi
cd ..

# Check for TODO/FIXME comments in production code
echo "ğŸ” Checking for TODO/FIXME comments..."
if git diff --name-only HEAD~1 HEAD | grep -E '\.(ts|tsx|js|jsx|py)$' | grep -v '\.test\.' | grep -v '\.spec\.' | xargs grep -l 'TODO\|FIXME\|HACK\|XXX'; then
  echo "âš ï¸  WARNING: Found TODO/FIXME comments in production code."
  echo "ğŸ’¡ Consider addressing these before pushing to main branch."
fi

# Check bundle size (if frontend files changed)
if git diff --name-only HEAD~1 HEAD | grep -E 'frontend/.*\.(ts|tsx|js|jsx)$' | grep -v '\.test\.' | grep -v '\.spec\.'; then
  echo "ğŸ“¦ Checking bundle size..."
  cd frontend
  npm run build:size-check
  if [ $? -ne 0 ]; then
    echo "âŒ Bundle size check failed. Please optimize your code before pushing."
    exit 1
  fi
  cd ..
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸ‰ Ready to push to remote repository!"
