name: Build Multi-Platform

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: "macos-latest"
                      os: "macOS"
                      target: "x86_64-apple-darwin"
                      artifact-name: "macos-x64"
                    - platform: "macos-latest"
                      os: "macOS"
                      target: "aarch64-apple-darwin"
                      artifact-name: "macos-arm64"
                    - platform: "windows-latest"
                      os: "Windows"
                      target: "x86_64-pc-windows-msvc"
                      artifact-name: "windows-x64"
                    - platform: "ubuntu-latest"
                      os: "Linux"
                      target: "x86_64-unknown-linux-gnu"
                      artifact-name: "linux-x64"

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "18"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Setup Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: "frontend/src-tauri -> target"

            - name: Install frontend dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Install Tauri CLI
              run: npm install -g @tauri-apps/cli@latest

            - name: Build frontend
              working-directory: ./frontend
              run: npm run build

            - name: Build Tauri app
              working-directory: ./frontend
              run: npm run tauri build

            - name: Upload macOS artifacts
              if: matrix.os == 'macOS'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact-name }}
                  path: |
                      frontend/src-tauri/target/release/bundle/dmg/*.dmg
                      frontend/src-tauri/target/release/bundle/macos/*.app
                  retention-days: 30

            - name: Upload Windows artifacts
              if: matrix.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact-name }}
                  path: |
                      frontend/src-tauri/target/release/bundle/msi/*.msi
                      frontend/src-tauri/target/release/bundle/nsis/*.exe
                  retention-days: 30

            - name: Upload Linux artifacts
              if: matrix.os == 'Linux'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact-name }}
                  path: |
                      frontend/src-tauri/target/release/bundle/appimage/*.AppImage
                      frontend/src-tauri/target/release/bundle/deb/*.deb
                  retention-days: 30

    create-release:
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./artifacts

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ github.run_number }}
                  name: Release v${{ github.run_number }}
                  body: |
                      ðŸš€ **Soft Robot Simulator v${{ github.run_number }}**

                      **Downloads:**
                      - **macOS (Intel)**: `macos-x64.zip`
                      - **macOS (Apple Silicon)**: `macos-arm64.zip`
                      - **Windows**: `windows-x64.zip`
                      - **Linux**: `linux-x64.zip`

                      **Installation:**
                      - **macOS**: Open the `.dmg` file and drag to Applications
                      - **Windows**: Run the `.exe` installer
                      - **Linux**: Use the `.AppImage` or install the `.deb` package
                  files: |
                      artifacts/macos-x64/*.dmg
                      artifacts/macos-arm64/*.dmg
                      artifacts/windows-x64/*.msi
                      artifacts/windows-x64/*.exe
                      artifacts/linux-x64/*.AppImage
                      artifacts/linux-x64/*.deb
                  draft: false
                  prerelease: false
