name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  CI: "true"

jobs:
  # Frontend Tests
  frontend:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps

      - name: Run linting
        run: |
          cd frontend
          npm run lint

      # - name: Run type checking
      #   run: |
      #     cd frontend
      #     npx tsc --noEmit

      - name: Run tests
        run: |
          cd frontend
          npm run test:run

      - name: Build frontend
        run: |
          cd frontend
          npm run build

  # Backend Tests
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff mypy

      - name: Run linting
        run: |
          cd backend
          python -m black --check app/
          ruff check app/

      # - name: Run type checking
      #   run: |
      #     cd backend
      #     python -m mypy app/ --ignore-missing-imports

      - name: Run tests
        run: |
          cd backend
          python -m pytest tests/ -v

  # Build Check
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libglib2.0-dev libsoup2.4-dev libjavascriptcoregtk-4.1-dev imagemagick

      - name: Create symbolic links for compatibility
        run: |
          # Create symbolic links to make 4.1 libraries available as 4.0 for compatibility
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so.0 /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so.18
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/javascriptcoregtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/javascriptcoregtk-4.0.pc

          # Create symbolic links for WebKit2GTK 4.1 -> 4.0 compatibility
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.0 /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so.37
          sudo ln -sf /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/x86_64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc

          # Create library symlinks for linker compatibility
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.0.so
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.1.so /usr/lib/x86_64-linux-gnu/libjavascriptcoregtk-4.0.so

      - name: Convert icons to RGBA format
        run: |
          cd frontend/src-tauri/icons
          # Convert all PNG icons to RGBA format for Tauri compatibility
          for icon in *.png; do
              if [ -f "$icon" ]; then
                  convert "$icon" -background transparent -alpha set "$icon"
              fi
          done

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Build Tauri app
        run: |
          cd frontend
          npm run tauri build
