name: Web Application CI/CD

on:
    push:
        branches: [main, develop, web-app-deployment]
    pull_request:
        branches: [main, develop, web-app-deployment]

env:
    NODE_VERSION: "20"
    PYTHON_VERSION: "3.11"
    CI: "true"

jobs:
    # Code Quality & Testing
    quality:
        name: Code Quality & Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install frontend dependencies
              run: |
                  cd frontend
                  npm ci
                  npx playwright install --with-deps

            - name: Install backend dependencies
              run: |
                  cd backend
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run frontend linting
              run: |
                  cd frontend
                  npm run lint

            - name: Run backend linting
              run: |
                  cd backend
                  ruff check app/
                  ruff format --check app/

            - name: Run frontend tests
              run: |
                  cd frontend
                  npm run test:run

            - name: Run backend tests
              run: |
                  cd backend
                  python -m pytest tests/ -v

            - name: Run integration tests
              run: |
                  cd frontend
                  npm run test:integration

    # Web Build & Performance
    build:
        name: Web Build & Performance
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              run: |
                  cd frontend
                  npm ci

            - name: Build web application
              run: |
                  cd frontend
                  npm run build

            - name: Build size analysis
              run: |
                  cd frontend
                  npm run build:size-check

            - name: Lighthouse performance audit
              run: |
                  cd frontend
                  npm run lighthouse:ci

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: web-build
                  path: frontend/dist/
                  retention-days: 7

    # Backend Build Check
    backend-build:
        name: Backend Build Check
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install backend dependencies
              run: |
                  cd backend
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Verify backend imports
              run: |
                  cd backend
                  python -c "import app.main; print('Backend imports successful')"

            - name: Check backend configuration
              run: |
                  cd backend
                  python -c "from app.config import settings; print('Configuration loaded successfully')"
