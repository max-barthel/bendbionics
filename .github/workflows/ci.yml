name: Web Application CI/CD

on:
    push:
        branches: [main, develop, web-app-deployment]
    pull_request:
        branches: [main, develop, web-app-deployment]

env:
    BUN_VERSION: "latest"
    PYTHON_VERSION: "3.11"
    CI: "true"

jobs:
    # Code Quality & Testing
    quality:
        name: Code Quality & Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Install frontend dependencies
              run: |
                  cd frontend
                  bun install
                  bunx playwright install --with-deps

            - name: Install backend dependencies
              run: |
                  cd backend
                  uv sync

            - name: Run frontend linting
              run: |
                  cd frontend
                  bun run lint

            - name: Run backend linting
              run: |
                  cd backend
                  uv run ruff check app/
                  uv run ruff format --check app/

            - name: Run frontend tests
              run: |
                  cd frontend
                  bun run test:run

            - name: Run backend tests
              run: |
                  cd backend
                  uv run pytest tests/ -v

            - name: Run integration tests
              run: |
                  cd frontend
                  bun run test:integration

    # Web Build & Performance
    build:
        name: Web Build & Performance
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: Install dependencies
              run: |
                  cd frontend
                  bun install

            - name: Build web application
              run: |
                  cd frontend
                  bun run build

            - name: Build size analysis
              run: |
                  cd frontend
                  bun run build:size-check

            - name: Lighthouse performance audit
              run: |
                  cd frontend
                  bun run lighthouse:ci

            - name: Cleanup old Lighthouse reports
              run: |
                  cd frontend
                  if [ -d "lighthouse-reports" ]; then
                    REPORT_COUNT=$(find lighthouse-reports -maxdepth 1 -name "*.report.*" -type f 2>/dev/null | wc -l | tr -d ' ')
                    if [ "$REPORT_COUNT" -gt 10 ]; then
                      cd lighthouse-reports
                      ls -t *.report.* 2>/dev/null | tail -n +11 | xargs rm -f 2>/dev/null || true
                      cd ..
                    fi
                  fi
                  rm -rf .lighthouseci 2>/dev/null || true

            - name: Upload build artifacts
              uses: actions/upload-artifact@v5
              with:
                  name: web-build
                  path: frontend/dist/
                  retention-days: 7

    # Backend Build Check
    backend-build:
        name: Backend Build Check
        runs-on: ubuntu-latest
        needs: quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install uv
              uses: astral-sh/setup-uv@v5
              with:
                  version: "latest"

            - name: Install backend dependencies
              run: |
                  cd backend
                  uv sync

            - name: Verify backend imports
              run: |
                  cd backend
                  uv run python -c "import app.main; print('Backend imports successful')"

            - name: Check backend configuration
              run: |
                  cd backend
                  uv run python -c "from app.config import settings; print('Configuration loaded successfully')"
