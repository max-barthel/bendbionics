name: Automated Deployment (replaces deploy-workflow.sh)

on:
    push:
        branches: [main, web-app-deployment]
    workflow_dispatch:
        inputs:
            skip_build:
                description: "Skip build step (use existing build)"
                required: false
                default: false
                type: boolean
            skip_upload:
                description: "Skip upload step (use existing package on server)"
                required: false
                default: false
                type: boolean
            skip_deploy:
                description: "Skip deploy step (just cleanup)"
                required: false
                default: false
                type: boolean
            cleanup_only:
                description: "Only cleanup old deployment packages"
                required: false
                default: false
                type: boolean

env:
    BUN_VERSION: "latest"
    PYTHON_VERSION: "3.11"
    CI: "true"
    HUSKY: "0"  # Suppress git hooks in CI
    # Server configuration (matches deploy-workflow.sh)
    SERVER_USER: "serveruser"
    SERVER_HOST: ${{ secrets.SERVER_HOST }}
    SERVER_PATH: "/tmp"

jobs:
    # Complete deployment workflow (replaces deploy-workflow.sh)
    deploy:
        name: üöÄ Complete Deployment Workflow
        runs-on: ubuntu-latest
        environment: production
        steps:
            - name: üéØ Checkout code
              uses: actions/checkout@v5

            - name: üîß Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: ${{ env.BUN_VERSION }}

            - name: üíæ Cache Bun dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      frontend/node_modules
                      ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('frontend/bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: üêç Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  version: "latest"

            - name: üì¶ Install dependencies
              run: |
                  cd frontend && bun install
                  cd ../backend && uv sync

            - name: üß™ Run frontend tests
              if: ${{ !inputs.skip_build }}
              run: |
                  cd frontend && bun run test:run

            - name: üß™ Run backend tests
              if: ${{ !inputs.skip_build }}
              run: |
                  cd backend && uv run pytest tests/ -v

            - name: üèóÔ∏è Build application
              if: ${{ !inputs.skip_build }}
              run: |
                  cd frontend
                  bun run build

            - name: üìÅ Create deployment package
              if: ${{ !inputs.skip_build }}
              run: |
                  # Create deployment directory (matches deploy-workflow.sh)
                  DEPLOY_DIR="deploy/web-build-$(date +%Y%m%d-%H%M%S)"
                  mkdir -p "$DEPLOY_DIR"

                  # Copy frontend build
                  mkdir -p "$DEPLOY_DIR/frontend"
                  cp -r frontend/dist/* "$DEPLOY_DIR/frontend/"

                  # Copy backend files (exclude test files and cache)
                  mkdir -p "$DEPLOY_DIR/backend"
                  cp -r backend/app "$DEPLOY_DIR/backend/"

                  # Copy database initialization and migration scripts
                  cp backend/init_database.py "$DEPLOY_DIR/backend/"
                  cp backend/migrate.py "$DEPLOY_DIR/backend/"

                  # Copy pyproject.toml (needed for uv)
                  cp backend/pyproject.toml "$DEPLOY_DIR/backend/"

                  # Clean up any __pycache__ directories that might have been copied
                  find "$DEPLOY_DIR/backend" -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
                  find "$DEPLOY_DIR/backend" -name "*.pyc" -delete 2>/dev/null || true
                  # Exclude test files
                  find "$DEPLOY_DIR/backend" -path "*/tests/*" -type f -delete 2>/dev/null || true
                  find "$DEPLOY_DIR/backend" -name "*_test.py" -type f -delete 2>/dev/null || true
                  find "$DEPLOY_DIR/backend" -name "test_*.py" -type f -delete 2>/dev/null || true

                  # Copy deployment configurations
                  cp -r config/nginx "$DEPLOY_DIR/"
                  cp -r config/systemd "$DEPLOY_DIR/"

                  # Copy deployment scripts
                  cp scripts/deploy/server-deploy.sh "$DEPLOY_DIR/deploy.sh"
                  cp scripts/deploy/start-backend.sh "$DEPLOY_DIR/start-backend.sh"
                  chmod +x "$DEPLOY_DIR/deploy.sh"
                  chmod +x "$DEPLOY_DIR/start-backend.sh"

                  # Copy PostgreSQL setup script
                  if [ -f "scripts/deploy/setup-postgres.sh" ]; then
                      cp scripts/deploy/setup-postgres.sh "$DEPLOY_DIR/setup-postgres.sh"
                      chmod +x "$DEPLOY_DIR/setup-postgres.sh"
                  fi

                  # Copy DDNS scripts (optional, for dynamic DNS setup)
                  if [ -d "scripts/ddns" ]; then
                      mkdir -p "$DEPLOY_DIR/scripts/ddns"
                      cp -r scripts/ddns/* "$DEPLOY_DIR/scripts/ddns/"
                      # Make all shell scripts executable
                      find "$DEPLOY_DIR/scripts/ddns" -name "*.sh" -type f -exec chmod +x {} \;
                  fi

                  # Store package name for later steps (cache for reuse)
                  echo "DEPLOY_PACKAGE=$DEPLOY_DIR" >> $GITHUB_ENV
                  echo "PACKAGE_NAME=$(basename $DEPLOY_DIR)" >> $GITHUB_ENV

            - name: üîç Validate Mailgun secrets
              if: ${{ !inputs.skip_build }}
              run: |
                  echo "üîç Validating Mailgun configuration..."

                  # Check if secrets are set
                  if [ -z "${{ secrets.MAILGUN_API_KEY }}" ]; then
                      echo "‚ùå MAILGUN_API_KEY secret is not set"
                      echo "   Please add MAILGUN_API_KEY to your GitHub repository secrets"
                      exit 1
                  fi

                  if [ -z "${{ secrets.MAILGUN_DOMAIN }}" ]; then
                      echo "‚ùå MAILGUN_DOMAIN secret is not set"
                      echo "   Please add MAILGUN_DOMAIN to your GitHub repository secrets"
                      exit 1
                  fi

                  # Validate domain format (should not include protocol)
                  DOMAIN="${{ secrets.MAILGUN_DOMAIN }}"
                  if [[ "$DOMAIN" == http* ]]; then
                      echo "‚ùå MAILGUN_DOMAIN should not include protocol (http/https)"
                      echo "   Use: mg.yourdomain.com"
                      echo "   Not: https://mg.yourdomain.com"
                      exit 1
                  fi

                  echo "‚úÖ Mailgun secrets validation passed"
                  echo "   Domain: $DOMAIN"
                  echo "   API Key: ${MAILGUN_API_KEY:0:8}..."

            - name: üìß Create production environment file
              if: ${{ !inputs.skip_build }}
              env:
                  MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }} # These env vars are used in the shell script below
                  MAILGUN_DOMAIN: ${{ secrets.MAILGUN_DOMAIN }} # yamllint disable-line
              run: |
                  # Use cached deployment directory
                  DEPLOY_DIR="${{ env.DEPLOY_PACKAGE }}"

                  # Create .env.production with email configuration
                  cat > "$DEPLOY_DIR/backend/.env.production" << 'EOF'
                  # BendBionics Production Environment Configuration
                  # Generated by GitHub Actions during deployment

                  # Application Settings
                  APP_NAME=BendBionics API
                  DEBUG=false
                  LOG_LEVEL=INFO

                  # CORS Configuration
                  CORS_ORIGINS=["https://bendbionics.com", "https://www.bendbionics.com"]
                  CORS_ALLOW_ALL_ORIGINS=false

                  # Database Configuration
                  # Note: DATABASE_URL and SECRET_KEY are set by setup-postgres.sh on server
                  # This file will be merged with server settings during deployment

                  # Email Settings (Mailgun)
                  EOF

                  # Append Mailgun secrets (environment variables from secrets)
                  echo "MAILGUN_API_KEY=${MAILGUN_API_KEY}" >> "$DEPLOY_DIR/backend/.env.production"
                  echo "MAILGUN_DOMAIN=${MAILGUN_DOMAIN}" >> "$DEPLOY_DIR/backend/.env.production"
                  echo "MAILGUN_REGION=eu" >> "$DEPLOY_DIR/backend/.env.production"

                  # Append remaining static config
                  cat >> "$DEPLOY_DIR/backend/.env.production" << 'EOF'
                  MAILGUN_FROM_EMAIL=noreply@bendbionics.com
                  MAILGUN_FROM_NAME=BendBionics

                  # Email Verification
                  EMAIL_VERIFICATION_ENABLED=true
                  EMAIL_VERIFICATION_TOKEN_EXPIRE_HOURS=24
                  EMAIL_VERIFICATION_URL=https://bendbionics.com/verify-email

                  # Password Reset
                  PASSWORD_RESET_TOKEN_EXPIRE_HOURS=1
                  PASSWORD_RESET_URL=https://bendbionics.com/reset-password

                  # Frontend/Backend URLs
                  FRONTEND_URL=https://bendbionics.com
                  BACKEND_URL=https://bendbionics.com
                  EOF

                  echo "‚úÖ Production environment file created with email configuration"

            - name: üîç Validate server configuration
              if: ${{ !inputs.skip_upload }}
              run: |
                  echo "üîç Validating server configuration..."

                  # Check if SERVER_HOST secret is set
                  if [ -z "${{ secrets.SERVER_HOST }}" ]; then
                      echo "‚ùå SERVER_HOST secret is not set"
                      echo "   Please add SERVER_HOST to your GitHub repository secrets"
                      echo "   Use either:"
                      echo "   - Your server's public IP address (e.g., 123.45.67.89)"
                      echo "   - Or a fully qualified domain name (e.g., server.bendbionics.com)"
                      exit 1
                  fi

                  # Check if SSH_PRIVATE_KEY secret is set
                  if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
                      echo "‚ùå SSH_PRIVATE_KEY secret is not set"
                      echo "   Please add SSH_PRIVATE_KEY to your GitHub repository secrets"
                      exit 1
                  fi

                  echo "‚úÖ Server configuration validation passed"
                  echo "   Server Host: ${{ secrets.SERVER_HOST }}"

            - name: üîë Setup SSH
              if: ${{ !inputs.skip_upload }}
              uses: webfactory/ssh-agent@v0.9.1
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: üîê Configure SSH known hosts
              if: ${{ !inputs.skip_upload }}
              run: |
                  echo "üîê Configuring SSH known hosts..."
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  # Add server host key to known_hosts to avoid "Host key verification failed"
                  ssh-keyscan -H "${{ env.SERVER_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null
                  chmod 600 ~/.ssh/known_hosts
                  echo "‚úÖ SSH known hosts configured"

            - name: üì§ Upload to server
              if: ${{ !inputs.skip_upload }}
              run: |
                  # Use cached deployment package
                  DEPLOY_PACKAGE="${{ env.DEPLOY_PACKAGE }}"

                  if [ -z "$DEPLOY_PACKAGE" ] || [ ! -d "$DEPLOY_PACKAGE" ]; then
                      echo "‚ùå No deployment package found. Run build first."
                      exit 1
                  fi

                  echo "üì¶ Compressing deployment package..."
                  PACKAGE_NAME="${{ env.PACKAGE_NAME }}"
                  tar -czf "${PACKAGE_NAME}.tar.gz" -C deploy "$PACKAGE_NAME"

                  echo "üì§ Uploading compressed package: ${PACKAGE_NAME}.tar.gz"
                  scp "${PACKAGE_NAME}.tar.gz" "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.SERVER_PATH }}/"

                  echo "üì¶ Extracting package on server..."
                  ssh "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}" "cd ${{ env.SERVER_PATH }} && tar -xzf ${PACKAGE_NAME}.tar.gz && rm -f ${PACKAGE_NAME}.tar.gz"

                  echo "üßπ Cleaning up local compressed package..."
                  rm -f "${PACKAGE_NAME}.tar.gz"

            - name: üöÄ Deploy on server
              if: ${{ !inputs.skip_deploy }}
              run: |
                  # Use cached package name
                  PACKAGE_NAME="${{ env.PACKAGE_NAME }}"

                  echo "üöÄ Deploying package: $PACKAGE_NAME"
                  # Deploy with sudo (requires passwordless sudo setup)
                  ssh -tt "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}" "cd ${{ env.SERVER_PATH }}/$PACKAGE_NAME && sudo ./deploy.sh"

            - name: üè• Health check
              if: ${{ !inputs.skip_deploy }}
              run: |
                  echo "üè• Checking application health..."
                  MAX_ATTEMPTS=12
                  ATTEMPT=0
                  SLEEP_INTERVAL=5

                  while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
                      if curl -f -s https://bendbionics.com/health > /dev/null 2>&1; then
                          echo "‚úÖ Health check passed!"
                          exit 0
                      fi

                      ATTEMPT=$((ATTEMPT + 1))
                      if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                          echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS failed, retrying in ${SLEEP_INTERVAL}s..."
                          sleep $SLEEP_INTERVAL
                      fi
                  done

                  echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
                  exit 1

            - name: üîç Verify deployment and cleanup
              if: ${{ !inputs.skip_deploy }}
              run: |
                  echo "üîç Verifying deployment and cleanup results..."
                  ssh "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}" "
                      # Verify service is running
                      echo 'üìä Service Status:'
                      sudo systemctl is-active bendbionics-api

                      # Check disk usage after cleanup
                      echo 'üíæ Disk Usage:'
                      df -h / | tail -1

                      # Verify backup was created
                      echo 'üíæ Backup Status:'
                      ls -lht /mnt/data/backups/database/ | head -3

                      # Check journal size
                      echo 'üìù Journal Size:'
                      journalctl --disk-usage

                      # Verify no old services running
                      echo 'üîß Active Services:'
                      systemctl list-units --type=service | grep -E 'robot|bendbionics' || echo 'Only bendbionics-api.service running ‚úÖ'
                  "

            - name: üßπ Cleanup local package
              if: ${{ !inputs.cleanup_only }}
              run: |
                  # Clean up local deployment package using cached path
                  DEPLOY_PACKAGE="${{ env.DEPLOY_PACKAGE }}"
                  if [ -n "$DEPLOY_PACKAGE" ] && [ -d "$DEPLOY_PACKAGE" ]; then
                      echo "üßπ Removing local package: $DEPLOY_PACKAGE"
                      rm -rf "$DEPLOY_PACKAGE"
                  fi

            - name: üßπ Cleanup old packages
              if: ${{ inputs.cleanup_only }}
              run: |
                  echo "üßπ Cleaning up old deployment packages..."
                  OLD_PACKAGES=$(find deploy -name "web-build-*" -type d 2>/dev/null | wc -l)
                  if [ "$OLD_PACKAGES" -gt 0 ]; then
                      echo "Found $OLD_PACKAGES old deployment packages"
                      rm -rf deploy/web-build-*
                      echo "‚úÖ Old packages cleaned up"
                  else
                      echo "No old packages found"
                  fi

            - name: üßπ Server cleanup
              if: ${{ !inputs.skip_deploy }}
              run: |
                  # Clean up server deployment package using cached name
                  PACKAGE_NAME="${{ env.PACKAGE_NAME }}"
                  if [ -n "$PACKAGE_NAME" ]; then
                      echo "üßπ Cleaning up server package..."
                      ssh "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}" "rm -rf ${{ env.SERVER_PATH }}/$PACKAGE_NAME"
                  fi

            - name: üéâ Deployment Results
              if: success()
              run: |
                  echo "üéâ Deployment Workflow Complete!"
                  echo ""
                  echo "üåê Application: https://bendbionics.com"
                  echo "üìö API Documentation: https://bendbionics.com/docs"
                  echo "üè• Health Check: https://bendbionics.com/health"
                  echo ""
                  echo "üîß Useful Commands:"
                  echo "View logs: ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'sudo journalctl -u bendbionics-api -f'"
                  echo "Restart backend: ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'sudo systemctl restart bendbionics-api'"
