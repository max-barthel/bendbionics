name: Automated Deployment (replaces deploy-workflow.sh)

on:
    push:
        branches: [main, web-app-deployment]
    workflow_dispatch:
        inputs:
            skip_build:
                description: "Skip build step (use existing build)"
                required: false
                default: false
                type: boolean
            skip_upload:
                description: "Skip upload step (use existing package on server)"
                required: false
                default: false
                type: boolean
            skip_deploy:
                description: "Skip deploy step (just cleanup)"
                required: false
                default: false
                type: boolean
            cleanup_only:
                description: "Only cleanup old deployment packages"
                required: false
                default: false
                type: boolean

env:
    NODE_VERSION: "20"
    PYTHON_VERSION: "3.11"
    # Server configuration (matches deploy-workflow.sh)
    SERVER_USER: "serveruser"
    SERVER_HOST: "bendbionics"
    SERVER_PATH: "/tmp"

jobs:
    # Complete deployment workflow (replaces deploy-workflow.sh)
    deploy:
        name: ğŸš€ Complete Deployment Workflow
        runs-on: ubuntu-latest
        environment: production
        steps:
            - name: ğŸ¯ Checkout code
              uses: actions/checkout@v5

            - name: ğŸ”§ Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: ğŸ Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: ğŸ“¦ Install dependencies
              run: |
                  cd frontend && npm ci
                  cd ../backend && pip install -r requirements.txt

            - name: ğŸ§ª Run tests
              if: ${{ !inputs.skip_build }}
              run: |
                  cd frontend && npm run test:run
                  cd ../backend && python -m pytest tests/ -v

            - name: ğŸ—ï¸ Build application
              if: ${{ !inputs.skip_build }}
              run: |
                  cd frontend
                  npm run build

            - name: ğŸ“ Create deployment package
              if: ${{ !inputs.skip_build }}
              run: |
                  # Create deployment directory (matches deploy-workflow.sh)
                  DEPLOY_DIR="deploy/web-build-$(date +%Y%m%d-%H%M%S)"
                  mkdir -p "$DEPLOY_DIR"

                  # Copy frontend build
                  mkdir -p "$DEPLOY_DIR/frontend"
                  cp -r frontend/dist/* "$DEPLOY_DIR/frontend/"

                  # Copy backend files
                  mkdir -p "$DEPLOY_DIR/backend"
                  cp -r backend/app "$DEPLOY_DIR/backend/"
                  cp backend/requirements.txt "$DEPLOY_DIR/backend/"

                    # Copy database initialization and migration scripts
                    cp backend/init_database.py "$DEPLOY_DIR/backend/"
                    cp backend/migrate.py "$DEPLOY_DIR/backend/"

                  # Copy deployment configurations
                  cp -r deploy/nginx "$DEPLOY_DIR/"
                  cp -r deploy/systemd "$DEPLOY_DIR/"
                  cp deploy.sh "$DEPLOY_DIR/"
                  chmod +x "$DEPLOY_DIR/deploy.sh"

                  # Store package name for later steps
                  echo "DEPLOY_PACKAGE=$DEPLOY_DIR" >> $GITHUB_ENV
                  echo "PACKAGE_NAME=$(basename $DEPLOY_DIR)" >> $GITHUB_ENV

            - name: ğŸ“§ Create production environment file
              if: ${{ !inputs.skip_build }}
              env:
                  MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }} # These env vars are used in the shell script below
                  MAILGUN_DOMAIN: ${{ secrets.MAILGUN_DOMAIN }} # yamllint disable-line
              run: |
                  # Find the deployment directory
                  DEPLOY_DIR=$(ls -td deploy/web-build-* 2>/dev/null | head -1)

                  # Create .env.production with email configuration
                  cat > "$DEPLOY_DIR/backend/.env.production" << 'EOF'
                  # BendBionics Production Environment Configuration
                  # Generated by GitHub Actions during deployment

                  # Application Settings
                  APP_NAME=Soft Robot API
                  DEBUG=false
                  LOG_LEVEL=INFO

                  # CORS Configuration
                  CORS_ORIGINS=["https://bendbionics.com", "https://www.bendbionics.com"]
                  CORS_ALLOW_ALL_ORIGINS=false

                  # Database Configuration
                  # Note: DATABASE_URL and SECRET_KEY are set by setup-postgres.sh on server
                  # This file will be merged with server settings during deployment

                  # Email Settings (Mailgun)
                  EOF

                  # Append Mailgun secrets (environment variables from secrets)
                  echo "MAILGUN_API_KEY=${MAILGUN_API_KEY}" >> "$DEPLOY_DIR/backend/.env.production"
                  echo "MAILGUN_DOMAIN=${MAILGUN_DOMAIN}" >> "$DEPLOY_DIR/backend/.env.production"

                  # Append remaining static config
                  cat >> "$DEPLOY_DIR/backend/.env.production" << 'EOF'
                  MAILGUN_FROM_EMAIL=noreply@bendbionics.com
                  MAILGUN_FROM_NAME=BendBionics

                  # Email Verification
                  EMAIL_VERIFICATION_ENABLED=true
                  EMAIL_VERIFICATION_TOKEN_EXPIRE_HOURS=24
                  EMAIL_VERIFICATION_URL=https://bendbionics.com/verify-email

                  # Password Reset
                  PASSWORD_RESET_TOKEN_EXPIRE_HOURS=1
                  PASSWORD_RESET_URL=https://bendbionics.com/reset-password

                  # Frontend/Backend URLs
                  FRONTEND_URL=https://bendbionics.com
                  BACKEND_URL=https://bendbionics.com
                  EOF

                  echo "âœ… Production environment file created with email configuration"

            - name: ğŸ”‘ Setup SSH
              if: ${{ !inputs.skip_upload }}
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: ğŸ“¤ Upload to server
              if: ${{ !inputs.skip_upload }}
              run: |
                  # Find the latest deployment package
                  LATEST_PACKAGE=$(ls -td deploy/web-build-* 2>/dev/null | head -1)

                  if [ -z "$LATEST_PACKAGE" ]; then
                      echo "âŒ No deployment package found. Run build first."
                      exit 1
                  fi

                  echo "ğŸ“¤ Uploading package: $LATEST_PACKAGE"
                  scp -r "$LATEST_PACKAGE" "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.SERVER_PATH }}/"

                  # Store package name for deployment
                  echo "PACKAGE_NAME=$(basename $LATEST_PACKAGE)" >> $GITHUB_ENV

            - name: ğŸš€ Deploy on server
              if: ${{ !inputs.skip_deploy }}
              run: |
                  # Find the latest deployment package
                  LATEST_PACKAGE=$(ls -td deploy/web-build-* 2>/dev/null | head -1)
                  PACKAGE_NAME=$(basename "$LATEST_PACKAGE")

                  echo "ğŸš€ Deploying package: $PACKAGE_NAME"
                  # Deploy with sudo (requires passwordless sudo setup)
                  ssh -tt "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}" "cd ${{ env.SERVER_PATH }}/$PACKAGE_NAME && sudo ./deploy.sh"

            - name: ğŸ¥ Health check
              if: ${{ !inputs.skip_deploy }}
              run: |
                  echo "â³ Waiting for deployment to complete..."
                  sleep 30
                  echo "ğŸ¥ Checking application health..."
                  curl -f https://bendbionics.com/health || exit 1
                  echo "âœ… Health check passed!"

            - name: ğŸ§¹ Cleanup local package
              if: ${{ !inputs.cleanup_only }}
              run: |
                  # Clean up local deployment package
                  LATEST_PACKAGE=$(ls -td deploy/web-build-* 2>/dev/null | head -1)
                  if [ -n "$LATEST_PACKAGE" ] && [ -d "$LATEST_PACKAGE" ]; then
                      echo "ğŸ§¹ Removing local package: $LATEST_PACKAGE"
                      rm -rf "$LATEST_PACKAGE"
                  fi

            - name: ğŸ§¹ Cleanup old packages
              if: ${{ inputs.cleanup_only }}
              run: |
                  echo "ğŸ§¹ Cleaning up old deployment packages..."
                  OLD_PACKAGES=$(find deploy -name "web-build-*" -type d 2>/dev/null | wc -l)
                  if [ "$OLD_PACKAGES" -gt 0 ]; then
                      echo "Found $OLD_PACKAGES old deployment packages"
                      rm -rf deploy/web-build-*
                      echo "âœ… Old packages cleaned up"
                  else
                      echo "No old packages found"
                  fi

            - name: ğŸ§¹ Server cleanup
              if: ${{ !inputs.skip_deploy }}
              run: |
                  # Clean up server deployment package
                  LATEST_PACKAGE=$(ls -td deploy/web-build-* 2>/dev/null | head -1)
                  PACKAGE_NAME=$(basename "$LATEST_PACKAGE")
                  if [ -n "$PACKAGE_NAME" ]; then
                      echo "ğŸ§¹ Cleaning up server package..."
                      ssh "${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}" "rm -rf ${{ env.SERVER_PATH }}/$PACKAGE_NAME"
                  fi

            - name: ğŸ‰ Deployment Results
              if: success()
              run: |
                  echo "ğŸ‰ Deployment Workflow Complete!"
                  echo ""
                  echo "ğŸŒ Application: https://bendbionics.com"
                  echo "ğŸ“š API Documentation: https://bendbionics.com/docs"
                  echo "ğŸ¥ Health Check: https://bendbionics.com/health"
                  echo ""
                  echo "ğŸ”§ Useful Commands:"
                  echo "View logs: ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'sudo journalctl -u bendbionics-api -f'"
                  echo "Restart backend: ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'sudo systemctl restart bendbionics-api'"
