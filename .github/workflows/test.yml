name: Test Suite

on:
    push:
        branches: [main, develop, web-app-deployment]
    pull_request:
        branches: [main, develop, web-app-deployment]

env:
    NODE_VERSION: "20"
    PYTHON_VERSION: "3.11"

jobs:
    # Frontend Tests
    frontend-tests:
        name: Frontend Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              run: |
                  cd frontend
                  npm ci
                  npx playwright install --with-deps

            - name: Run unit tests
              run: |
                  cd frontend
                  npm run test:run

            - name: Run tests with coverage
              run: |
                  cd frontend
                  npm run test:coverage

            - name: Run integration tests
              run: |
                  cd frontend
                  npm run test:integration

            - name: Run visual regression tests
              run: |
                  cd frontend
                  npm run test:visual

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: frontend-test-results
                  path: |
                      frontend/coverage/
                      frontend/test-results/
                  retention-days: 7

    # Backend Tests
    backend-tests:
        name: Backend Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install dependencies
              run: |
                  cd backend
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run backend tests
              run: |
                  cd backend
                  python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=html

            - name: Upload coverage reports
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: backend-coverage
                  path: |
                      backend/htmlcov/
                      backend/coverage.xml
                  retention-days: 7

    # Code Quality
    quality-checks:
        name: Code Quality
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: Install dependencies
              run: |
                  cd frontend && npm ci
                  cd ../backend && pip install -r requirements.txt

            - name: Frontend linting
              run: |
                  cd frontend
                  npm run lint

            - name: Frontend type checking
              run: |
                  cd frontend
                  npx tsc --noEmit

            - name: Backend linting
              run: |
                  cd backend
                  ruff check app/
                  ruff format --check app/

            - name: Backend type checking
              run: |
                  cd backend
                  python -m mypy app/ --ignore-missing-imports

            - name: Security audit
              run: |
                  cd frontend && npm audit --audit-level moderate
                  cd ../backend && pip install safety && safety check

    # Performance Tests
    performance-tests:
        name: Performance Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              run: |
                  cd frontend
                  npm ci

            - name: Build application
              run: |
                  cd frontend
                  npm run build

            - name: Bundle size analysis
              run: |
                  cd frontend
                  npm run build:size-check

            - name: Lighthouse performance audit
              run: |
                  cd frontend
                  npm run lighthouse:ci

            - name: Upload performance results
              uses: actions/upload-artifact@v4
              with:
                  name: performance-results
                  path: |
                      frontend/lighthouse-results/
                      frontend/bundle-size-report.json
                  retention-days: 7

    # Test Summary
    test-summary:
        name: Test Summary
        runs-on: ubuntu-latest
        needs:
            [frontend-tests, backend-tests, quality-checks, performance-tests]
        if: always()
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: ./test-results

            - name: Generate test summary
              run: |
                  echo "## ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Frontend Tests" >> $GITHUB_STEP_SUMMARY
                  echo "- Unit Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "- Integration Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "- Visual Regression: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Backend Tests" >> $GITHUB_STEP_SUMMARY
                  echo "- Unit Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "- API Tests: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Quality Checks" >> $GITHUB_STEP_SUMMARY
                  echo "- Linting: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "- Type Checking: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "- Security Audit: âœ… Passed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Performance" >> $GITHUB_STEP_SUMMARY
                  echo "- Bundle Size: âœ… Within limits" >> $GITHUB_STEP_SUMMARY
                  echo "- Lighthouse Score: âœ… Good" >> $GITHUB_STEP_SUMMARY
