name: Test Suite

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    CI: "true"

jobs:
    test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [20.x]

        steps:
            - uses: actions/checkout@v5

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v5
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: Install dependencies
              run: |
                  cd frontend
                  npm ci
                  npx playwright install --with-deps

            - name: Run linting
              run: |
                  cd frontend
                  npm run lint

            - name: Run tests with coverage
              run: |
                  cd frontend
                  npm run test:ci

            # - name: Upload coverage reports to Codecov
            #   uses: codecov/codecov-action@v5
            #   with:
            #     files: ./frontend/coverage/lcov.info
            #     flags: unittests
            #     name: codecov-umbrella
            #     fail_ci_if_error: true

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: test-results-${{ matrix.node-version }}
                  path: frontend/test-results.xml
                  retention-days: 30

    test-report:
        needs: test
        runs-on: ubuntu-latest
        if: always()

        steps:
            - name: Download test results
              uses: actions/download-artifact@v5
              with:
                  path: test-results

            # - name: Publish Test Results
            #   uses: EnricoMi/publish-unit-test-result-action@v2
            #   if: always()
            #   with:
            #     files: "test-results/**/*.xml"
